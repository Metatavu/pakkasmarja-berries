language: node_js
node_js:
  - "8"
cache:
  directories:
    - keycloak-3.4.3.Final
addons:
  mariadb: '10.1'
services:
  - rabbitmq
  - redis-server
before_install:
  - gem install sass
install: npm install && grunt
before_script:
  - curl -sSL "https://github.com/wkhtmltopdf/wkhtmltopdf/releases/download/0.12.4/wkhtmltox-0.12.4_linux-generic-amd64.tar.xz"|tar -xvJ
  - rmdir keycloak-3.4.3.Final --ignore-fail-on-non-empty
  - npm install -g coveralls
  - cp test/config.json .
  - mysql -e 'CREATE DATABASE pm /*!40100 DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci */'
  - ./scripts/start-keycloak.sh
  - npm run instrument
  - npm run run-cover &
  - sleep 20
script:
  - npm run test
after_success:
  - curl -XPOST http://localhost:3002/system/shutdown
  - npm run coverage
  - cat ./coverage/lcov.info | coveralls