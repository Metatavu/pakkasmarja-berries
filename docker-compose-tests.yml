version: "3"
services:
  sap-mock:
    image: metatavu/odata-mock:latest
    environment:
      ODATA_MOCK_EDM_FILE: /opt/odata/edm.xml
      ODATA_MOCK_SESSION_COOKIE_NAME: B1SESSION
      ODATA_MOCK_SESSION_COMPANYDB: companydb
      ODATA_MOCK_SESSION_USERNAME: sapuser
      ODATA_MOCK_SESSION_PASSWORD: sappass
    volumes:
      - ./test-volumes/odata-mock:/opt/odata
  erp-service:
    image: metatavu/erp-service:latest
    environment:
      FI_METATAVU_PAKKASMARJA_SAP_API_URL: http://sap-mock:8080/odata
      FI_METATAVU_PAKKASMARJA_SAP_COMPANY_DB: companydb
      FI_METATAVU_PAKKASMARJA_SAP_USER_NAME: sapuser
      FI_METATAVU_PAKKASMARJA_SAP_USER_PASSWORD: sappass
      QUARKUS_OIDC_AUTH_SERVER_URL: http://test-keycloak:8080/auth/realms/pm
      QUARKUS_OIDC_CLIENT_ID: erp
  pm-mysql:
    image: mysql:5.7
    command: --lower_case_table_names=1
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: pm
      MYSQL_USER: pm
      MYSQL_PASSWORD: random
    ports:
      - 3306:3306
  test-keycloak:
    image: jboss/keycloak:4.8.3.Final
    environment:
      KEYCLOAK_USER: admin
      KEYCLOAK_PASSWORD: admin
      KEYCLOAK_IMPORT: /opt/docker/kc.json
      DB_VENDOR: h2
    ports:
      - 8080:8080
    volumes:
      - ./test-volumes/keycloak:/opt/docker
  pakkasmarja-api:
    build: .
    environment:
      STARTUP_DELAY: 35
    ports:
      - 3002:3000
    depends_on:
      - pm-mysql
      - test-keycloak
    healthcheck:
        test: curl http://test-keycloak:8080
        interval: 2s
        timeout: 5s
        retries: 30
    volumes:
      - ./test-volumes/pakkasmarja-api/config.json:/usr/src/pakkasmarja/config.json
      - ./test-volumes/pakkasmarja-api/app-config.json:/usr/src/pakkasmarja/app-config.json
      - /tmp/pakkasmail:/tmp/pakkasmail
      - /tmp/pakkaspush:/tmp/pakkaspush
      - /tmp/sapxml:/tmp/sapxml
  pakkasmarja-tests:
    build:
      context: .
      dockerfile: Dockerfile.tests
    environment:
      TEST_HOST: http://pakkasmarja-api:3000
    depends_on:
      - pakkasmarja-api
      - pm-mysql
      - test-keycloak
      - sap-mock
      - erp-service
    volumes:
      - ./test-volumes/pakkasmarja-api/config.json:/usr/src/pakkasmarja/config.json
      - ./test-volumes/pakkasmarja-api/app-config.json:/usr/src/pakkasmarja/app-config.json
      - /tmp/pakkasmail:/tmp/pakkasmail
      - /tmp/pakkaspush:/tmp/pakkaspush
      - /tmp/sapxml:/tmp/sapxml
